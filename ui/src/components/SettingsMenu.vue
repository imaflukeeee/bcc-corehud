<template>
  <div v-if="visible" class="settings-overlay">
    <div class="settings-window">
      
      <div class="sidebar">
        <div class="brand">
          <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ HUD</span>
        </div>
        
        <button 
          :class="['nav-btn', { active: currentTab === 'general' }]" 
          @click="currentTab = 'general'"
        >
          ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
        </button>
        <button 
          :class="['nav-btn', { active: currentTab === 'palette' }]" 
          @click="currentTab = 'palette'"
        >
          ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏™‡∏µ
        </button>

        <div class="footer-actions">
          <button class="btn btn-save" @click="saveSettings">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
          <button class="btn btn-close" @click="closeMenu">‡∏õ‡∏¥‡∏î</button>
        </div>
      </div>

      <div class="content-area">
        
        <div v-if="currentTab === 'general'">
          <h2 class="section-title">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h2>
          
          <div class="option-card">
            <div class="option-info">
              <h3>‡πÅ‡∏™‡∏î‡∏á HUD</h3>
              <p>‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• HUD ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            </div>
            <button class="btn" @click="toggleHud">‡∏ã‡πà‡∏≠‡∏ô / ‡πÅ‡∏™‡∏î‡∏á</button>
          </div>

          <div class="option-card" style="margin-top:10px;">
            <div class="option-info">
              <h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</h3>
              <p>‡∏•‡∏≤‡∏Å‡πÅ‡∏•‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á HUD</p>
            </div>
            <button class="btn" @click="editLayout">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</button>
          </div>

          <div class="option-card" style="margin-top:10px;">
            <div class="option-info">
              <h3>‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</h3>
              <p>‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á HUD ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏°</p>
            </div>
            <button class="btn" @click="resetLayout">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
          </div>

          <div class="option-card" style="margin-top:10px;">
            <div class="option-info">
              <h3>‡∏Æ‡∏µ‡∏•‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</h3>
              <p>‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏û‡∏•‡∏±‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï/‡∏™‡πÅ‡∏ï‡∏°‡∏¥‡∏ô‡πà‡∏≤ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)</p>
            </div>
            <button class="btn" @click="healPlayer">‡∏Æ‡∏µ‡∏•‡∏ï‡∏±‡∏ß‡∏â‡∏±‡∏ô</button>
          </div>
        </div>

        <div v-if="currentTab === 'palette'">
          <h2 class="section-title">‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏™‡∏µ</h2>
          <div class="palette-grid">
            <div v-for="(val, key) in paletteData" :key="key" class="color-control">
              <div class="color-header">
                <span style="text-transform: capitalize; color:#fff;">{{ getLabel(key) }}</span>
                <div class="color-preview" :style="{ background: getPreviewColor(val.hue, val.saturation) }"></div>
              </div>
              
              <div class="slider-row">
                <span style="width:50px;">‡πÄ‡∏â‡∏î‡∏™‡∏µ</span> <input type="range" min="0" max="360" v-model.number="val.hue" @input="updatePreview(key)">
                <span style="width:30px; text-align:right;">{{ val.hue }}</span>
              </div>
              
              <div class="slider-row">
                <span style="width:70px;">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°</span> <input type="range" min="0" max="100" v-model.number="val.saturation" @input="updatePreview(key)">
                <span style="width:30px; text-align:right;">{{ val.saturation }}</span>
              </div>
            </div>
          </div>
        </div>

      </div>

    </div>
  </div>
</template>

<script>
const post = (endpoint, data) => {
  if (window.GetParentResourceName) {
    fetch(`https://${window.GetParentResourceName()}/${endpoint}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data || {})
    }).catch(() => {});
  }
};

export default {
  data() {
    return {
      visible: false,
      currentTab: 'general',
      paletteData: {}
    };
  },
  mounted() {
    window.addEventListener('message', this.onMessage);
    document.addEventListener('keydown', this.onKey);
  },
  beforeUnmount() {
    window.removeEventListener('message', this.onMessage);
    document.removeEventListener('keydown', this.onKey);
  },
  methods: {
    // üëá ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤ (‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‡πÉ‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)
    getLabel(key) {
      const labels = {
        'health': '‡∏û‡∏•‡∏±‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï',
        'stamina': '‡∏™‡πÄ‡∏ï‡∏°‡∏¥‡∏ô‡πà‡∏≤',
        'hunger': '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏¥‡∏ß',
        'thirst': '‡∏Å‡∏£‡∏∞‡∏´‡∏≤‡∏¢‡∏ô‡πâ‡∏≥',
        'stress': '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î',
        'clean_stats': '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î',
        'temperature': '‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥',
        'horse_health': '‡∏û‡∏•‡∏±‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏°‡πâ‡∏≤',
        'horse_stamina': '‡∏™‡πÄ‡∏ï‡∏°‡∏¥‡∏ô‡πà‡∏≤‡∏°‡πâ‡∏≤',
        'horse_dirt': '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏Å‡∏õ‡∏£‡∏Å‡∏°‡πâ‡∏≤',
        'voice': '‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô',
        'messages': '‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢'
      };
      return labels[key] || key;
    },

    onMessage(event) {
      const data = event.data;
      if (data.type === 'open_settings') {
        this.visible = true;
        if (data.palette) {
          this.paletteData = JSON.parse(JSON.stringify(data.palette));
        }
      }
      if (data.type === 'close_settings') {
        this.visible = false;
      }
    },
    onKey(e) {
      if (this.visible && (e.key === 'Escape')) {
        this.closeMenu();
      }
    },
    closeMenu() {
      this.visible = false;
      post('closeSettings');
    },
    toggleHud() { post('toggleHudCommand'); },
    editLayout() {
      this.closeMenu();
      post('setLayoutEditing', { editing: true });
    },
    resetLayout() { post('resetLayoutCommand'); },
    healPlayer() { post('healPlayerCommand'); },
    saveSettings() {
      post('savePalette', { snapshot: this.paletteData });
      this.closeMenu();
    },
    updatePreview(key) {
      post('previewPalette', { 
         key: key, 
         hue: this.paletteData[key].hue, 
         saturation: this.paletteData[key].saturation 
      });
    },
    getPreviewColor(h, s) {
      return `hsl(${h}, ${s}%, 50%)`;
    }
  }
};
</script>

<style scoped>
@import url('https://fonts.googleapis.com/css2?family=Pridi:wght@300;400;500;600;700&display=swap');

.settings-overlay, 
.settings-overlay * {
  font-family: 'Pridi', serif !important;
}
</style>